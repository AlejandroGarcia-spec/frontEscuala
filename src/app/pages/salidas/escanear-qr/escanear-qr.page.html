<ion-header [translucent]="true">
  <ion-toolbar color="primary" class="ion-text-center">
    <ion-title>CREDENCIAL DIGITAL</ion-title>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/" text=""></ion-back-button>
    </ion-buttons>
  </ion-toolbar>
  <ion-toolbar color="light">
    <ion-title size="small" class="ion-text-center">
      <ion-card-subtitle>REGISTRO DE SALIDAS</ion-card-subtitle>
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <!-- Botón para mostrar escáner QR -->
  <ion-button *ngIf="!mostrarScanner" expand="block" color="primary" (click)="mostrarEscanner()"
    style="margin-bottom: 20px;">
    <ion-icon name="qr-code-outline" slot="start"></ion-icon>
    Leer QR
  </ion-button>

  <!-- Escáner QR (solo se muestra cuando se activa) -->
  <div *ngIf="mostrarScanner">
    <zxing-scanner *ngIf="!alumno" [torch]="true" [tryHarder]="true" (scanSuccess)="onCodeResult($event)">
    </zxing-scanner>

    <!-- Botón para ocultar escáner -->
    <ion-button *ngIf="!alumno" expand="block" color="medium" (click)="ocultarEscanner()" style="margin-top: 10px;">
      Cerrar Escáner
    </ion-button>

    <!-- Card de confirmación de salida -->
    <ion-card *ngIf="alumno">
      <ion-card-header>
        <ion-card-title>{{ alumno.nombre }} - {{ alumno.grado }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p><strong>Autorizado:</strong> {{ autorizado.nombre }} {{ autorizado.apellido }}</p>
        <p><strong>Parentesco:</strong> {{ autorizado.parentesco }}</p>
        <img *ngIf="autorizado.foto" [src]="autorizado.foto" style="width:100px; border-radius:8px" />

        <ion-item>
          <ion-label>Autorizar salida</ion-label>
          <ion-toggle [(ngModel)]="salidaAutorizada"></ion-toggle>
        </ion-item>

        <ion-button expand="block" color="success" [disabled]="!salidaAutorizada" (click)="confirmarSalida()">
          Confirmar autorización
        </ion-button>
        <ion-button expand="block" color="medium" (click)="reset()">Cancelar</ion-button>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Lista de salidas registradas - OPTIMIZADA PARA MÓVIL -->
  <ion-card *ngIf="!mostrarScanner">
    <ion-card-header>
      <ion-card-title>Historial de Salidas</ion-card-title>

      <!-- Filtros optimizados para móvil -->
      <ion-grid>
        <ion-row>
          <ion-col size="6">
            <ion-item>
              <ion-select placeholder="Grupo" [(ngModel)]="filtroGrupo" (ionChange)="onFiltroGrupoChange()"
                interface="action-sheet">
                <ion-select-option value="">Todos</ion-select-option>
                <ion-select-option *ngFor="let grupo of grupos" [value]="grupo.nombre">
                  {{ grupo.nombre }}
                </ion-select-option>
              </ion-select>
            </ion-item>
          </ion-col>
          <ion-col size="6">
            <ion-item>
              <ion-select placeholder="Fecha" [(ngModel)]="filtroFecha" (ionChange)="onFiltroFechaChange()"
                interface="action-sheet">
                <ion-select-option value="">Todas</ion-select-option>
                <ion-select-option *ngFor="let fecha of fechas" [value]="fecha">
                  {{ fecha }}
                </ion-select-option>
              </ion-select>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-header>

    <ion-card-content style="padding: 0;">
      <!-- Lista tipo cards para móvil -->
      <div *ngIf="salidasFiltradas.length > 0; else noSalidas">
        <ion-item-sliding *ngFor="let salida of salidasFiltradas; trackBy: trackBySalidaId">
          <ion-item>
            <ion-grid>
              <ion-row>
                <ion-col size="8">
                  <ion-label>
                    <h2><strong>{{ obtenerNombreAlumno(salida) }}</strong></h2>
                    <p><ion-icon name="school-outline"></ion-icon> {{ obtenerNombreGrupo(salida) }}</p>
                    <p><ion-icon name="person-outline"></ion-icon> {{ salida.nombre_Recoge }}</p>
                  </ion-label>
                </ion-col>
                <ion-col size="4" class="ion-text-right">
                  <ion-label>
                    <p><strong>{{ formatearHora(salida.Date) }}</strong></p>
                    <p style="font-size: 0.8em;">{{ formatearFecha(salida.Date) }}</p>
                    <!-- <ion-badge color="primary">#{{ salida.id }}</ion-badge> -->
                  </ion-label>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-item>

          <!-- Botón deslizable para eliminar -->
          <ion-item-options side="end">
            <ion-item-option color="danger" (click)="eliminarSalida(salida.id)">
              <ion-icon name="trash-outline"></ion-icon>
              Eliminar
            </ion-item-option>
          </ion-item-options>
        </ion-item-sliding>
      </div>

      <!-- Mensaje cuando no hay salidas -->
      <ng-template #noSalidas>
        <ion-item>
          <ion-label class="ion-text-center">
            <ion-icon name="clipboard-outline" size="large"></ion-icon>
            <h2 *ngIf="!filtroGrupo && !filtroFecha">No hay salidas registradas</h2>
            <h2 *ngIf="filtroGrupo || filtroFecha">No hay salidas con los filtros seleccionados</h2>
            <p *ngIf="!filtroGrupo && !filtroFecha">Los registros aparecerán aquí</p>
            <p *ngIf="filtroGrupo">Grupo: <strong>{{ filtroGrupo }}</strong></p>
            <p *ngIf="filtroFecha">Fecha: <strong>{{ filtroFecha }}</strong></p>
          </ion-label>
        </ion-item>
      </ng-template>
    </ion-card-content>
  </ion-card>

</ion-content>